
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>mkam339 — حجز داخلي + تحويل بنكي</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { scroll-behavior:smooth; }
    /* تحسين الرندر للغة العربية */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans Arabic", "Noto Sans", "Liberation Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; }
  </style>
  <!--
    ملاحظات مهمة:
    1) قبل التشغيل الفعلي: ضع مفاتيح Supabase في CONFIG داخل السكربت أسفل الصفحة (url, anonKey).
    2) نفّذ أوامر SQL لإنشاء الجداول والسياسات والدوال (init_profile) و Trigger منع تغيير الدور.
    3) أنشئ Bucket باسم receipts واجعله Public لرفع الإيصالات.
    4) لا يوجد أي localStorage — الجلسة لا تحفظ في المتصفح.
  -->
</head>
<body class="bg-white text-black">
  <div id="app"></div>

  <!-- React + ReactDOM + Babel (للتطوير السريع) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const CONFIG = {
      brand: { name: "mkam339", tagline: "مصمم مواقع — حجز داخلي + دفع تحويل بنكي" },
      company: { name: "شركة السهل واللين", url: "https://example.com", about: "شركة تعمل في اللوحات الإرشادية وتضم قسمًا للمبرمجين، وأنا عضو في هذا القسم." },
      colors: { blue: "#2563eb", green: "#16a34a", black: "#0a0a0a" },
      // ضع مفاتيح Supabase هنا
      supabase: { url: "", anonKey: "" },
      contact: { phone: "+9665XXXXXXX", email: "contact@mkam339.dev" },
    };

    function useSupabase() {
      return useMemo(() => {
        const { url, anonKey } = CONFIG.supabase || {};
        if (!url || !anonKey) return null;
        return window.supabase.createClient(url, anonKey, {
          auth: {
            persistSession: false,        // لا تخزين محلي للجلسة
            autoRefreshToken: true,
            // تخزين مخصص لا يقوم بأي شيء — يمنع القراءة/الكتابة إلى localStorage
            storage: {
              getItem: async () => null,
              setItem: async () => {},
              removeItem: async () => {},
            },
          },
        });
      }, []);
    }

    const Badge = ({ children }) => (
      <span className="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-semibold"
            style={{ borderColor: "#e5e7eb", color: CONFIG.colors.blue, background: CONFIG.colors.blue + "10" }}>
        {children}
      </span>
    );

    const Section = ({ id, title, subtitle, children }) => (
      <section id={id} className="py-20">
        <div className="mx-auto max-w-7xl px-4">
          <div className="mb-10 flex flex-col gap-3">
            <h2 className="text-3xl md:text-4xl font-extrabold text-black">{title}</h2>
            {subtitle && <p className="text-base text-neutral-600 max-w-3xl">{subtitle}</p>}
          </div>
          {children}
        </div>
      </section>
    );

    const NavBar = ({ onLoginClick, isAdmin }) => (
      <header className="sticky top-0 z-50 border-b border-neutral-200 bg-white/90 backdrop-blur">
        <div className="mx-auto flex max-w-7xl items-center justify-between px-4 py-3">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl border border-black/20 flex items-center justify-center font-black">mk</div>
            <div className="leading-tight">
              <div className="font-extrabold text-black uppercase tracking-widest">{CONFIG.brand.name}</div>
              <div className="text-xs text-neutral-500">{CONFIG.brand.tagline}</div>
            </div>
          </div>
          <nav className="hidden md:flex items-center gap-6 text-sm font-medium">
            <a href="#portfolio" className="hover:text-black/70">معرض الأعمال</a>
            <a href="#services" className="hover:text-black/70">الخدمات</a>
            <a href="#process" className="hover:text-black/70">الخطوات</a>
            <a href="#booking" className="hover:text-black/70">الحجز</a>
            <a href="#faq" className="hover:text-black/70">الأسئلة</a>
            {isAdmin && <a href="#admin" className="hover:text-black/70">لوحة التحكم</a>}
          </nav>
          <div className="flex items-center gap-2">
            <button onClick={onLoginClick} className="rounded-xl border border-neutral-300 px-4 py-2 text-sm font-semibold hover:bg-neutral-50">تسجيل الدخول</button>
          </div>
        </div>
      </header>
    );

    const Hero = () => (
      <div className="border-b border-neutral-200 bg-white">
        <div className="mx-auto max-w-7xl px-4 py-20">
          <div className="grid grid-cols-1 gap-10 md:grid-cols-12 items-center">
            <div className="md:col-span-7 flex flex-col gap-6">
              <Badge>حجز داخلي — دون تطبيقات خارجية</Badge>
              <h1 className="text-4xl md:text-6xl font-black text-black leading-[1.1]">مواقع احترافية مع حجز ودفع تحويل بنكي ولوحة مشرف</h1>
              <p className="text-neutral-700 md:text-xl max-w-2xl">حجوزات ومتابعة مدفوعات داخلية تُحفظ في قاعدة بيانات Supabase، مع إدارة كاملة للمشرف.</p>
              <div className="flex flex-wrap items-center gap-4">
                <a href="#booking" className="rounded-2xl px-6 py-3 text-base font-extrabold text-white"
                   style={{ background: `linear-gradient(90deg, ${CONFIG.colors.blue}, ${CONFIG.colors.green})` }}>احجز الآن</a>
                <a href="#portfolio" className="rounded-2xl border border-neutral-300 px-6 py-3 text-base font-bold hover:bg-neutral-50">أعمالي</a>
              </div>
              <div className="flex items-center gap-3 pt-2">
                <Badge>من <a href={CONFIG.company.url} target="_blank" rel="noreferrer" className="underline underline-offset-4">{CONFIG.company.name}</a></Badge>
              </div>
            </div>
            <div className="md:col-span-5">
              <div className="rounded-3xl border border-neutral-200 overflow-hidden">
                <div className="bg-black text-white p-4 text-sm">عرض سريع</div>
                <div className="p-6 bg-white">
                  <div className="grid gap-3 md:grid-cols-2">
                    <input type="date" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" />
                    <input type="time" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" />
                    <input placeholder="الاسم" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm md:col-span-2" />
                    <button className="rounded-xl px-4 py-2 text-sm font-bold text-white md:col-span-2" style={{ background: CONFIG.colors.black }}>احجز</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div className="bg-black text-white">
          <div className="mx-auto max-w-7xl px-4 py-8 grid gap-4 md:grid-cols-3 text-sm">
            <div>سرعة تنفيذ عالية</div>
            <div>حفظ آمن للبيانات في قاعدة بيانات</div>
            <div>دعم وإدارة من شركة السهل واللين</div>
          </div>
        </div>
      </div>
    );

    const Services = () => {
      const items = [
        { t: 'مواقع شركات', d: 'صفحات هبوط ومواقع تعريفية محسّنة للتحويل.' },
        { t: 'متاجر خفيفة', d: 'كتالوج + طلبات عبر التحويل البنكي.' },
        { t: 'لوحات إدارة', d: 'لوحة مشرف لإدارة حجوزات ومدفوعات وإعدادات.' },
      ];
      return (
        <div className="grid gap-6 md:grid-cols-3">
          {items.map((x,i)=> (
            <div key={i} className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
              <div className="text-lg font-extrabold text-black mb-2">{x.t}</div>
              <p className="text-sm text-neutral-600">{x.d}</p>
            </div>
          ))}
        </div>
      );
    };

    const Process = () => {
      const steps = [
        ['طلب وتفاصيل', 'تعبئة نموذج الحجز وشرح المتطلبات'],
        ['عربون', 'تحويل بنكي مع مرجع الدفع'],
        ['التنفيذ', 'تصميم وتطوير وتسليم أولي'],
        ['التسليم', 'تحسينات أخيرة وإطلاق']
      ];
      return (
        <div className="grid gap-6 md:grid-cols-4">
          {steps.map(([t,d],i)=> (
            <div key={i} className="rounded-2xl border border-neutral-200 bg-white p-6 text-sm">
              <div className="mb-2 text-black font-extrabold">{i+1}. {t}</div>
              <div className="text-neutral-600">{d}</div>
            </div>
          ))}
        </div>
      );
    };

    const Portfolio = () => (
      <div className="text-sm text-neutral-600">أضف أعمالك وروابطها وصورًا هنا لاحقًا…</div>
    );

    function useBankSettings(supabase) {
      const [bank, setBank] = useState({ bankName: "", accountName: "", iban: "", note: "اكتب مرجع الدفع عند التحويل" });
      useEffect(() => {
        if (!supabase) return;
        let channel;
        (async () => {
          const { data } = await supabase.from('settings').select('value').eq('key','bank').maybeSingle();
          if (data && data.value) setBank(prev => ({ ...prev, ...data.value }));
          // Realtime: تُحدّث الإعدادات فورًا للجميع
          channel = supabase.channel('settings-bank')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'settings', filter: 'key=eq.bank' }, (payload) => {
              const v = payload.new?.value; if (v) setBank(prev => ({...prev, ...v}));
            })
            .subscribe();
        })();
        return () => { channel && supabase.removeChannel(channel); };
      }, [supabase]);
      return [bank, setBank];
    }

    function BookingForm({ supabase, user }) {
      const [bank] = useBankSettings(supabase);
      const [form, setForm] = useState({ date: '', time: '', name: '', email: '', phone: '', notes: '', amount: '' });
      const [bookingId, setBookingId] = useState(null);
      const [reference, setReference] = useState('');
      const [receiptUrl, setReceiptUrl] = useState('');
      const [step, setStep] = useState(1);
      const [msg, setMsg] = useState('');

      function genRef() {
        const r = `MK-${Math.random().toString(36).slice(2,8).toUpperCase()}-${Date.now().toString().slice(-4)}`;
        setReference(r);
        return r;
      }

      async function submitBooking(e) {
        e.preventDefault();
        if (!supabase || !user) { setMsg('سجل الدخول أولاً.'); return; }
        setMsg('');
        const { data, error } = await supabase.from('bookings').insert({
          user_id: user.id, name: form.name, email: form.email, phone: form.phone,
          date: form.date || null, time: form.time || null, notes: form.notes, status: 'pending',
        }).select('id').single();
        if (error) { setMsg(error.message); return; }
        setBookingId(data.id); genRef(); setStep(2);
      }

      async function uploadReceipt(file) {
        if (!supabase || !file || !user) return;
        const path = `${user.id}/${Date.now()}_${file.name}`;
        const { error } = await supabase.storage.from('receipts').upload(path, file);
        if (error) { setMsg('تعذر رفع الإيصال'); return; }
        const { data } = await supabase.storage.from('receipts').getPublicUrl(path);
        if (data && data.publicUrl) setReceiptUrl(data.publicUrl);
      }

      async function savePayment() {
        if (!supabase || !user) return;
        const { error } = await supabase.from('payments').insert({
          user_id: user.id, booking_id: bookingId, method: 'bank',
          amount: form.amount ? Number(form.amount) : null,
          currency: 'SAR', status: 'awaiting_verification', reference, receipt_url: receiptUrl || null,
        });
        setMsg(error ? 'تعذر حفظ بيانات الدفع' : 'تم تسجيل بيانات التحويل، سيتم التأكيد بعد المراجعة');
      }

      if (step === 2) {
        return (
          <div className="space-y-4">
            <div className="rounded-xl border border-neutral-200 p-4">
              <div className="mb-2 text-lg font-extrabold text-black">بيانات التحويل البنكي</div>
              <ul className="text-sm text-neutral-700 space-y-1">
                <li>البنك: <b>{bank.bankName || '—'}</b></li>
                <li>اسم الحساب: <b>{bank.accountName || '—'}</b></li>
                <li>IBAN: <b>{bank.iban || '—'}</b></li>
                <li>مرجع الدفع: <b>{reference}</b></li>
              </ul>
              <div className="mt-2 text-xs text-neutral-500">{bank.note}</div>
            </div>
            <div className="rounded-xl border border-neutral-200 p-4">
              <div className="mb-2 text-sm font-bold">رفع إيصال التحويل (اختياري)</div>
              <input type="file" accept="image/*,application/pdf" onChange={(e)=>uploadReceipt(e.target.files?.[0])} />
              {receiptUrl && <div className="text-xs text-green-700 mt-2">تم الرفع</div>}
            </div>
            <div className="flex items-center gap-3">
              <button onClick={savePayment} className="rounded-xl px-4 py-2 text-sm font-extrabold text-white"
                      style={{ background: `linear-gradient(90deg, ${CONFIG.colors.blue}, ${CONFIG.colors.green})` }}>تأكيد تسجيل التحويل</button>
              <a href="#" onClick={(e)=>{e.preventDefault(); setStep(1);}} className="text-sm">رجوع</a>
            </div>
            {msg && <div className="text-xs text-neutral-600">{msg}</div>}
          </div>
        );
      }

      return (
        <form onSubmit={submitBooking} className="space-y-3">
          <div className="grid gap-2 md:grid-cols-2">
            <input type="date" required className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                   value={form.date} onChange={e=>setForm({...form, date:e.target.value})} />
            <input type="time" required className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                   value={form.time} onChange={e=>setForm({...form, time:e.target.value})} />
          </div>
          <input placeholder="الاسم" required className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                 value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
          <input type="email" placeholder="البريد" required className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                 value={form.email} onChange={e=>setForm({...form, email:e.target.value})} />
          <input placeholder="الهاتف" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                 value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} />
          <textarea placeholder="ملاحظات/وصف المشروع" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" rows="3"
                    value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})} />
          <input type="number" step="0.01" placeholder="قيمة العربون (اختياري)" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm"
                 value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} />
          <button type="submit" className="rounded-xl px-4 py-2 text-sm font-extrabold text-white"
                  style={{ background: `linear-gradient(90deg, ${CONFIG.colors.blue}, ${CONFIG.colors.green})` }}>احجز وانتقل لخطوة التحويل</button>
          {msg && <div className="text-xs text-red-600">{msg}</div>}
        </form>
      );
    }

    const BookingSection = ({ supabase, user }) => (
      <div className="grid gap-6 md:grid-cols-2">
        <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div className="mb-2 text-lg font-extrabold text-black">احجز موعد استشارة</div>
          <p className="mb-4 text-sm text-neutral-600">املأ النموذج وسيتم حفظ الطلب في النظام. بعدها ستظهر لك بيانات التحويل البنكي مع مرجع الدفع.</p>
          <BookingForm supabase={supabase} user={user} />
        </div>
        <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div className="mb-2 text-lg font-extrabold text-black">كيف يعمل الدفع بالتحويل البنكي؟</div>
          <ol className="list-decimal ps-6 text-sm text-neutral-700 space-y-2">
            <li>أحجز موعدك عبر الاستمارة.</li>
            <li>سيظهر لك مرجع الدفع وبيانات الحساب البنكي.</li>
            <li>قم بالتحويل مع كتابة المرجع في خانة الوصف.</li>
            <li>يمكنك رفع إيصال التحويل، وسيتم التأكيد بعد المراجعة.</li>
          </ol>
        </div>
      </div>
    );

    const FAQ = () => {
      const q = [
        ['هل يلزم دفع عربون؟', 'العربون اختياري ويمكن تحديد قيمته في استمارة الحجز.'],
        ['هل أحتاج حسابًا؟', 'نعم لتثبيت الحجز، لكن الجلسة لا تُخزن محليًا حفاظًا على الخصوصية.'],
        ['متى تظهر تغييرات المشرف؟', 'فورًا عبر Realtime، وتظهر لجميع الزوار.'],
      ];
      return (
        <div className="divide-y">
          {q.map(([t,a],i)=>(
            <div key={i} className="py-4">
              <div className="font-extrabold text-black mb-1">{t}</div>
              <div className="text-sm text-neutral-600">{a}</div>
            </div>
          ))}
        </div>
      );
    };

    const Contact = () => (
      <div className="grid gap-6 md:grid-cols-2">
        <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div className="mb-2 text-lg font-extrabold text-black">تواصل معي</div>
          <p className="mb-4 text-sm text-neutral-600">راسلني عبر البريد أو واتساب وسأرد بأسرع وقت.</p>
          <div className="space-y-2 text-sm">
            <div>البريد: <a className="underline" href={`mailto:${CONFIG.contact.email}`}>{CONFIG.contact.email}</a></div>
            <div>واتساب: <a className="underline" href={`https://wa.me/${CONFIG.contact.phone.replace(/[^0-9]/g, "")}`} target="_blank" rel="noreferrer">{CONFIG.contact.phone}</a></div>
          </div>
        </div>
        <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div className="mb-2 text-lg font-extrabold text-black">عن {CONFIG.company.name}</div>
          <p className="mb-3 text-sm text-neutral-700">{CONFIG.company.about}</p>
          <a href={CONFIG.company.url} target="_blank" rel="noreferrer"
             className="inline-flex items-center justify-center rounded-2xl px-5 py-3 text-sm font-extrabold text-white"
             style={{ background: CONFIG.colors.black }}>موقع الشركة</a>
        </div>
      </div>
    );

    function AdminDashboard({ supabase, profile }) {
      const isAdmin = profile?.role === 'admin';
      const [tab, setTab] = useState('overview');
      const [bookings, setBookings] = useState([]);
      const [payments, setPayments] = useState([]);
      const [bank, setBank] = useState({ bankName: '', accountName: '', iban: '', note: '' });
      const [msg, setMsg] = useState('');

      useEffect(() => {
        (async () => {
          if (!supabase || !isAdmin) return;
          const { data: b } = await supabase.from('bookings').select('*').order('created_at', { ascending: false });
          setBookings(b || []);
          const { data: p } = await supabase.from('payments').select('*').order('created_at', { ascending: false });
          setPayments(p || []);
          const { data: s } = await supabase.from('settings').select('value').eq('key','bank').maybeSingle();
          if (s && s.value) setBank(prev => ({ ...prev, ...s.value }));
        })();
      }, [supabase, isAdmin, tab]);

      async function updateBookingStatus(id, status) {
        if (!supabase) return;
        await supabase.from('bookings').update({ status }).eq('id', id);
        setBookings(prev => prev.map(b => b.id === id ? { ...b, status } : b));
      }

      async function updatePaymentStatus(id, status) {
        if (!supabase) return;
        await supabase.from('payments').update({ status }).eq('id', id);
        setPayments(prev => prev.map(p => p.id === id ? { ...p, status } : p));
      }

      async function saveBank() {
        if (!supabase) return;
        const { error } = await supabase.from('settings').upsert({ key:'bank', value: bank, updated_at: new Date().toISOString() });
        setMsg(error ? 'تعذر الحفظ' : 'تم حفظ بيانات البنك (ستظهر فورًا للجميع)');
      }

      if (!isAdmin) return <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm text-sm">يجب تسجيل الدخول كمشرف لرؤية لوحة التحكم.</div>;

      return (
        <div className="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
          <div className="mb-4 flex items-center gap-2 text-sm">
            {['overview','bookings','payments','settings'].map(t => (
              <button key={t} onClick={()=>setTab(t)} className={`rounded-xl border px-3 py-1 ${tab===t? 'bg-neutral-50' : ''}`}>{t}</button>
            ))}
          </div>

          {tab==='overview' && (
            <div className="grid gap-4 md:grid-cols-3">
              <div className="rounded-xl border p-4"><div className="text-xs text-neutral-500">إجمالي الحجوزات</div><div className="text-2xl font-black">{bookings.length}</div></div>
              <div className="rounded-xl border p-4"><div className="text-xs text-neutral-500">دفعات قيد المراجعة</div><div className="text-2xl font-black">{payments.filter(p=>p.status==='awaiting_verification').length}</div></div>
              <div className="rounded-xl border p-4"><div className="text-xs text-neutral-500">مدفوع</div><div className="text-2xl font-black">{payments.filter(p=>p.status==='paid').length}</div></div>
            </div>
          )}

          {tab==='bookings' && (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-neutral-500"><th className="p-2">التاريخ</th><th className="p-2">الوقت</th><th className="p-2">العميل</th><th className="p-2">الهاتف</th><th className="p-2">الحالة</th><th className="p-2">إجراءات</th></tr>
                </thead>
                <tbody>
                  {bookings.map(b => (
                    <tr key={b.id} className="border-t">
                      <td className="p-2">{b.date || '—'}</td>
                      <td className="p-2">{b.time || '—'}</td>
                      <td className="p-2">{b.name}</td>
                      <td className="p-2">{b.phone || '—'}</td>
                      <td className="p-2">{b.status}</td>
                      <td className="p-2 flex gap-2">
                        <button onClick={()=>updateBookingStatus(b.id,'confirmed')} className="rounded border px-2 py-1">تأكيد</button>
                        <button onClick={()=>updateBookingStatus(b.id,'canceled')} className="rounded border px-2 py-1">إلغاء</button>
                        <button onClick={()=>updateBookingStatus(b.id,'paid')} className="rounded border px-2 py-1">تم الدفع</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {tab==='payments' && (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-neutral-500"><th className="p-2">المبلغ</th><th className="p-2">العملة</th><th className="p-2">المرجع</th><th className="p-2">الإيصال</th><th className="p-2">الحالة</th><th className="p-2">إجراءات</th></tr>
                </thead>
                <tbody>
                  {payments.map(p => (
                    <tr key={p.id} className="border-t">
                      <td className="p-2">{p.amount || '—'}</td>
                      <td className="p-2">{p.currency}</td>
                      <td className="p-2">{p.reference}</td>
                      <td className="p-2">{p.receipt_url ? <a className="underline" href={p.receipt_url} target="_blank" rel="noreferrer">عرض</a> : '—'}</td>
                      <td className="p-2">{p.status}</td>
                      <td className="p-2 flex gap-2">
                        <button onClick={()=>updatePaymentStatus(p.id,'paid')} className="rounded border px-2 py-1">وسم كمدفوع</button>
                        <button onClick={()=>updatePaymentStatus(p.id,'rejected')} className="rounded border px-2 py-1">رفض</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {tab==='settings' && (
            <div className="space-y-3 max-w-lg">
              <div className="text-sm text-neutral-600">حدّث بيانات التحويل البنكي التي تظهر للعملاء (تُحدّث فوريًا للجميع).</div>
              <input placeholder="اسم البنك" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" value={bank.bankName} onChange={e=>setBank({...bank, bankName:e.target.value})} />
              <input placeholder="اسم الحساب" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" value={bank.accountName} onChange={e=>setBank({...bank, accountName:e.target.value})} />
              <input placeholder="IBAN" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" value={bank.iban} onChange={e=>setBank({...bank, iban:e.target.value})} />
              <textarea placeholder="ملاحظة تظهر للعميل" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" rows="3" value={bank.note} onChange={e=>setBank({...bank, note:e.target.value})} />
              <button onClick={async()=>{ await saveBank(); }} className="rounded-xl px-4 py-2 text-sm font-extrabold text-white" style={{ background: CONFIG.colors.black }}>حفظ</button>
              {msg && <div className="text-xs text-neutral-600">{msg}</div>}
            </div>
          )}
        </div>
      );
    }

    function AuthModal({ open, onClose, onAuthChange }) {
      const supabase = useSupabase();
      const [mode, setMode] = useState('login');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        if (!supabase) return;
        const { data: sub } = supabase.auth.onAuthStateChange((_, session)=>{ onAuthChange?.(session?.user || null); });
        supabase.auth.getSession().then(({ data })=> onAuthChange?.(data.session?.user || null));
        return () => sub?.subscription?.unsubscribe();
      }, [supabase]);

      async function handleAuth(e) {
        e.preventDefault(); setError('');
        if (!supabase) { setError('فعّل Supabase في CONFIG'); return; }
        setLoading(true);
        try {
          if (mode==='login') {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
          } else {
            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) throw error;
            if (data && data.user) {
              // بروفايل client فقط (الدالة يجب إنشاؤها في SQL مسبقًا)
              try { await supabase.rpc('init_profile'); } catch (e) {}
            }
          }
        } catch (err) {
          setError(err?.message || 'حدث خطأ');
        } finally { setLoading(false); }
      }

      if (!open) return null;
      return (
        <div className="fixed inset-0 z-[60] grid place-items-center bg-black/40 p-4" onClick={onClose}>
          <div className="w-full max-w-md rounded-2xl border border-neutral-200 bg-white p-6 shadow-xl" onClick={(e)=>e.stopPropagation()}>
            <div className="mb-4 flex items-center justify-between"><div className="text-lg font-extrabold text-black">تسجيل الدخول</div><button onClick={onClose} className="rounded-xl border px-3 py-1 text-xs">إغلاق</button></div>
            <form onSubmit={handleAuth} className="space-y-3">
              <div className="flex gap-2 text-xs">
                <button type="button" className={"rounded-xl border px-3 py-1 " + (mode==='login'?'bg-neutral-50':'')} onClick={()=>setMode('login')}>تسجيل الدخول</button>
                <button type="button" className={'rounded-xl border px-3 py-1 ' + (mode==='signup'?'bg-neutral-50':'')} onClick={()=>setMode('signup')}>حساب جديد</button>
              </div>
              <input type="email" placeholder="البريد الإلكتروني" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" value={email} onChange={(e)=>setEmail(e.target.value)} required />
              <input type="password" placeholder="كلمة المرور" className="w-full rounded-xl border border-neutral-300 px-3 py-2 text-sm" value={password} onChange={(e)=>setPassword(e.target.value)} required />
              {error && <div className="text-xs text-red-600">{error}</div>}
              <button type="submit" disabled={loading} className="w-full rounded-xl px-4 py-2 text-sm font-extrabold text-white disabled:opacity-60" style={{ background: CONFIG.colors.black }}>{loading ? 'جارٍ المعالجة…' : (mode==='login' ? 'تسجيل الدخول' : 'إنشاء الحساب')}</button>
              {(!CONFIG.supabase.url || !CONFIG.supabase.anonKey) && <div className="mt-2 text-xs text-neutral-500">ضع مفاتيح Supabase في CONFIG داخل هذا الملف ثم أعد التحميل.</div>}
            </form>
          </div>
        </div>
      );
    }

    const Footer = () => (
      <footer className="bg-black text-white">
        <div className="mx-auto flex max-w-7xl flex-col items-center justify-between gap-4 px-4 py-10 md:flex-row">
          <div className="text-xs opacity-80">© {new Date().getFullYear()} {(CONFIG.brand && CONFIG.brand.name) || 'mkam339'}. جميع الحقوق محفوظة.</div>
          <div className="flex items-center gap-4 text-xs">
            <a href="#portfolio" className="hover:underline">أعمالي</a>
            <a href="#services" className="hover:underline">الخدمات</a>
            <a href="#process" className="hover:underline">الخطوات</a>
            <a href="#booking" className="hover:underline">الحجز</a>
            <a href="#faq" className="hover:underline">الأسئلة</a>
            <a href="#admin" className="hover:underline">لوحة التحكم</a>
          </div>
        </div>
      </footer>
    );

    function App() {
      const supabase = useSupabase();
      const [authOpen, setAuthOpen] = useState(false);
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);

      useEffect(() => {
        (async () => {
          if (!supabase) return;
          const { data } = await supabase.auth.getUser();
          setUser(data?.user || null);
        })();
      }, [supabase]);

      useEffect(() => {
        (async () => {
          if (!supabase || !user) { setProfile(null); return; }
          const { data } = await supabase.from('profiles').select('role, full_name, phone').eq('id', user.id).maybeSingle();
          setProfile(data || { role: 'client' });
        })();
      }, [supabase, user]);

      const isAdmin = profile?.role === 'admin';

      return (
        <div className="min-h-screen bg-white text-black">
          <NavBar onLoginClick={() => setAuthOpen(true)} isAdmin={isAdmin} />
          <Hero />

          <Section id="services" title="الخدمات" subtitle="حلول مواقع احترافية بخيارات دفع وتحكم داخلي">
            <Services />
          </Section>

          <Section id="process" title="خطوات العمل" subtitle="آلية واضحة من أول اتصال حتى الإطلاق">
            <Process />
          </Section>

          <Section id="portfolio" title="معرض الأعمال" subtitle="أعمال مختارة — انقر للمشاهدة">
            <Portfolio />
          </Section>

          <Section id="booking" title="الحجز والدفع" subtitle="حجز داخلي + تحويل بنكي مباشر">
            <BookingSection supabase={supabase} user={user} />
          </Section>

          <Section id="faq" title="الأسئلة الشائعة">
            <FAQ />
          </Section>

          <Section id="about" title={`عن ${CONFIG.brand.name}`} subtitle="الانتماء — شركة السهل واللين">
            <Contact />
          </Section>

          <Section id="admin" title="لوحة التحكم" subtitle="عرض الحجوزات والمدفوعات وتحديث بيانات البنك">
            <AdminDashboard supabase={supabase} profile={profile} />
          </Section>

          <Footer />

          <AuthModal open={authOpen} onClose={() => setAuthOpen(false)} onAuthChange={(u)=>{ setUser(u); }} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<App />);
  </script>
</body>
</html>
